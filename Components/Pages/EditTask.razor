@page "/tasks/edit/{TaskId:int}"
@using TaskManager.Models
@using TaskManager.Services
@inject ITaskService TaskService
@inject ISessionService SessionService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Editar Tarea</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            @if (isLoading)
            {
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else if (model == null)
            {
                <div class="alert alert-danger">
                    Tarea no encontrada
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-header">
                        <h3>Editar Tarea</h3>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <EditForm Model="@model" OnValidSubmit="@HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="mb-3">
                                <label class="form-label">Título: *</label>
                                <InputText @bind-Value="model.Title" class="form-control" placeholder="Título de la tarea" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Descripción: *</label>
                                <InputTextArea @bind-Value="model.Description" class="form-control" rows="4" placeholder="Describe la tarea..." />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Fecha de Vencimiento: *</label>
                                <InputDate @bind-Value="model.DueDate" class="form-control" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Estado:</label>
                                <InputSelect @bind-Value="model.Status" class="form-select">
                                  <option value="@TaskItemStatus.Pendiente">Pendiente</option>
<option value="@TaskItemStatus.EnProgreso">En Progreso</option>
<option value="@TaskItemStatus.Completada">Completada</option>
                                </InputSelect>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span>Guardando...</span>
                                    }
                                    else
                                    {
                                        <span>Guardar Cambios</span>
                                    }
                                </button>
                                <a href="/tasks" class="btn btn-secondary">Cancelar</a>
                            </div>
                        </EditForm>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int TaskId { get; set; }

    private TaskModel? model;
    private string errorMessage = string.Empty;
    private bool isProcessing = false;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        if (SessionService.CurrentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadTask();
    }

    private async Task LoadTask()
    {
        isLoading = true;

        var task = await TaskService.GetTaskByIdAsync(TaskId);

        if (task == null || task.UserId != SessionService.CurrentUser!.Id)
        {
            model = null;
        }
        else
        {
            model = new TaskModel
            {
                Id = task.Id,
                Title = task.Title,
                Description = task.Description,
                DueDate = task.DueDate,
                Status = task.Status,
                UserId = task.UserId
            };
        }

        isLoading = false;
    }

    private async Task HandleSubmit()
    {
        if (model == null) return;

        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            // Validación
            if (string.IsNullOrWhiteSpace(model.Title))
            {
                errorMessage = "El título es obligatorio";
                return;
            }

            if (string.IsNullOrWhiteSpace(model.Description))
            {
                errorMessage = "La descripción es obligatoria";
                return;
            }

            var task = new TaskItem
            {
                Id = model.Id,
                Title = model.Title,
                Description = model.Description,
                DueDate = model.DueDate,
                Status = model.Status,
                UserId = model.UserId
            };

            var result = await TaskService.UpdateTaskAsync(task);

            if (result == null)
            {
                errorMessage = "Error al actualizar la tarea";
                return;
            }

            Navigation.NavigateTo("/tasks");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al actualizar la tarea: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    public class TaskModel
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime DueDate { get; set; }
        public TaskItemStatus Status { get; set; }
        public int UserId { get; set; }
    }
}